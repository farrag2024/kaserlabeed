<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل درجات الاختبارات القصيرة</title>
    <link rel="icon" href="9999.png" type="image/png">
    <style>
        .exit-button {
            background-color: red;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        body {
            background-image: url('222.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            text-align: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        table {
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #studentTable {
            display: none;
            margin-top: 20px;
            border-collapse: collapse;
            background-color: rgba(247, 233, 214, 0.9);
        }
        table, th, td {
            border: 1px solid black;
            padding: 8px;
            font-weight: bold;
            font-size: 16px;
        }
        th:nth-child(1), td:nth-child(1) {
            width: 40px;
        }
        th:nth-child(2), td:nth-child(2) {
            width: 20px;
        }
        th:nth-child(3), td:nth-child(3) {
            width: 250px;
        }
        th:nth-child(4), td:nth-child(4),
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7),
        th:nth-child(8), td:nth-child(8),
        th:nth-child(9), td:nth-child(9),
        th:nth-child(10), td:nth-child(10),
        th:nth-child(11), td:nth-child(11) {
            width: 20px;
        }
        input {
            width: 50px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }
        input.student-name {
            width: 250px;
            font-size: 16px;
            color: #640404;
            font-weight: bold;
        }
        input.row.cl_num {
            width: 55px;
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }
        .filter-container {
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .save-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        select {
            background-color: hsl(195, 83%, 82%);
            font-size: 18px;
            padding: 5px;
            width: 120px;
            height: 40px;
            border: 2px solid #010a01;
            border-radius: 20px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            margin: 0 5px;
        }
        .show-button {
            background-color: blue;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        .logo {
            margin-top: 10px;
            width: 150px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            height: auto;
        }
        .readonly-field {
            border: none;
            background-color: transparent;
            pointer-events: none;
            font-family: inherit;
            font-size: inherit;
        }
        #updateAllStudents {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: none;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        #loadingMessage {
            color: blue;
            font-weight: bold;
            display: none;
            margin-bottom: 10px;
        }
        h1 {
            color: #333;
            margin: 15px 0;
        }
        label {
            font-weight: bold;
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <img src="9999.png" alt="Logo" class="logo">
    <h1>رصد درجات الاختبارات القصيرة 25/26</h1>
    
    <!-- رسالة الحفظ -->
    <div id="loadingMessage">جاري الحفظ، برجاء الانتظار...</div>

    <!-- Filter and Show Table Button -->
    <div class="filter-container">
        <select id="classFilter" onchange="updateSubjects()">
            <option value="">اختار الصف</option>
            <option value="خامس 1">خامس 1</option>
            <option value="خامس 2">خامس 2</option>
            <option value="خامس 3">خامس 3</option>
            <option value="خامس 4">خامس 4</option>
            <option value="خامس 5">خامس 5</option>
            <option value="خامس 6">خامس 6</option>
            <option value="سادس 1">سادس 1</option>
            <option value="سادس 2">سادس 2</option>
            <option value="سادس 3">سادس 3</option>
            <option value="سادس 4">سادس 4</option>
            <option value="سادس 5">سادس 5</option>
            <option value="سادس 5">سادس 6</option>
            <option value="سابع 1">سابع 1</option>
            <option value="سابع 2">سابع 2</option>
            <option value="سابع 3">سابع 3</option>
            <option value="سابع 4">سابع 4</option>
            <option value="سابع 5">سابع 5</option>
            <option value="ثامن 1">ثامن 1</option>
            <option value="ثامن 2">ثامن 2</option>
            <option value="ثامن 3">ثامن 3</option>
            <option value="ثامن 4">ثامن 4</option>
            <option value="ثامن 5">ثامن 5</option>
            <option value="تاسع 1">تاسع 1</option>
            <option value="تاسع 2">تاسع 2</option>
            <option value="تاسع 3">تاسع 3</option>
            <option value="تاسع 4">تاسع 4</option>
            <option value="تاسع 5">تاسع 5</option>

        </select>
        
        <select id="subjectFilter">
            <option value="">-- اختار المادة --</option>
            <option value="aslm">التربية الاسلامية</option>
            <option value="arb">اللغة العربية</option>
            <option value="math">الرياضيات</option>
            <option value="since">العلوم</option>
            <option value="drasa">الدراسات</option>
            <option value="eng">اللغة الانجليزية</option>
            <option value="fyz">فيزياء</option>
            <option value="kims">كيمياء</option>
            <option value="ahya">احياء</option>
        </select>
        
        <button onclick="showTable()" class="show-button">عــرض</button>
        <button id="updateAllStudents" onclick="updateAllStudents()">حفظ التعديلات</button>
    </div>

    <!-- Table to display the data -->
    <table id="studentTable">
        <thead>
            <tr>
                <th>م</th>
                <th>الصف</th>
                <th>اسم الطالب</th>
                <th>اسلامية</th>
                <th>عربي</th>
                <th>رياضيات</th>
                <th>علوم</th>
                <th>دراسات</th>
                <th>انجليزي</th>
                <th>فيزياء</th>
                <th>كيمياء</th>
                <th>احياء</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be populated here -->
        </tbody>
    </table>
    
    <button onclick="closePage()" class="exit-button">خروج</button>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbztCJGQzunQW6HJen1ggtgZ-IlQISvqzQ85_7_g0H3UmJM_Ya28fFiGIu1-922Gmiej/exec';
        let allStudentsData = []; // لتخزين جميع البيانات
        let currentFilter = { class: '', subject: '' }; // لتخزين حالة التصفية الحالية
        
        function closePage() {
            window.close();
        }
        
        function loadData() {
            fetch(scriptURL)
                .then(response => response.json())
                .then(data => {
                    allStudentsData = data; // حفظ جميع البيانات
                    renderTable(data);
                    
                    // إذا كان هناك تصفية نشطة، إعادة تطبيقها
                    if (currentFilter.class && currentFilter.subject) {
                        document.getElementById('classFilter').value = currentFilter.class;
                        document.getElementById('subjectFilter').value = currentFilter.subject;
                        applyFilter(currentFilter.class, currentFilter.subject);
                    }
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    alert('حدث خطأ في تحميل البيانات');
                });
        }
        
        function renderTable(data) {
            const tableBody = document.querySelector("#studentTable tbody");
            tableBody.innerHTML = ''; // مسح البيانات الحالية

            data.forEach((row) => {
                const newRow = document.createElement("tr");
                newRow.setAttribute('data-class', row.cl_num);

                newRow.innerHTML = `
                    <td>${row.id}</td>
                    <td><input type="text" class="cl_num" value="${row.cl_num}" id="cl_num_${row.id}" readonly></td>
                    <td><input type="text" class="student-name" value="${row.student_name}" id="student_name_${row.id}" readonly></td>
                    <td><input type="number" value="${row.aslm}" id="aslm_${row.id}" data-original="${row.aslm}" min="0" max="35"></td>
                    <td><input type="number" value="${row.arb}" id="arb_${row.id}" data-original="${row.arb}" min="0" max="35"></td>
                    <td><input type="number" value="${row.math}" id="math_${row.id}" data-original="${row.math}" min="0" max="35"></td>
                    <td><input type="number" value="${row.since}" id="since_${row.id}" data-original="${row.since}" min="0" max="35"></td>
                    <td><input type="number" value="${row.drasa}" id="drasa_${row.id}" data-original="${row.drasa}" min="0" max="35"></td>
                    <td><input type="number" value="${row.eng}" id="eng_${row.id}" data-original="${row.eng}" min="0" max="35"></td>
                    <td><input type="number" value="${row.fyz}" id="fyz_${row.id}" data-original="${row.fyz}" min="0" max="35"></td>
                    <td><input type="number" value="${row.kims}" id="kims_${row.id}" data-original="${row.kims}" min="0" max="35"></td>
                    <td><input type="number" value="${row.ahya}" id="ahya_${row.id}" data-original="${row.ahya}" min="0" max="35"></td>
                `;

                tableBody.appendChild(newRow);
            });
            
            // إضافة مستمعي الأحداث لحقول الإدخال
            addInputListeners();
        }
        
        function addInputListeners() {
            const numberInputs = document.querySelectorAll('input[type="number"]');
            
            numberInputs.forEach(input => {
                input.addEventListener('input', function() {
                    validateValue(this);
                });
                
                input.addEventListener('keydown', function(event) {
                    if (event.key === '-' || event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                        event.preventDefault();
                    }
                });
                
                input.addEventListener('keypress', function(event) {
                    if (!/[0-9]/.test(event.key) && event.key !== 'Backspace' && event.key !== 'Tab') {
                        event.preventDefault();
                    }
                    
                    const newValue = this.value + event.key;
                    
                    if (newValue.length > 2) {
                        event.preventDefault();
                        showMessage('يرجى إدخال رقم مكون من رقمين كحد أقصى.');
                    }
                    
                    if (parseInt(newValue) > 35) {
                        event.preventDefault();
                        showMessage('الرجاء التأكد من الدرجة.');
                    }
                });
                
                input.addEventListener('blur', function() {
                    validateValue(this);
                });
            });
        }
        
        function validateValue(input) {
            if (input.value < 0) {
                input.value = 0;
                showMessage('يرجى إدخال رقم موجب فقط.');
            } else if (input.value > 35) {
                input.value = 35;
                showMessage('الرجاء التأكد من الدرجة.');
            }
        }
        
        function showMessage(message) {
            alert(message);
        }
        
        function updateSubjects() {
            const classFilterValue = document.getElementById('classFilter').value;
            const subjectFilter = document.getElementById('subjectFilter');
            
            // استعادة جميع الخيارات
            const allOptions = [
                { value: "aslm", text: "التربية الاسلامية" },
                { value: "arb", text: "اللغة العربية" },
                { value: "math", text: "الرياضيات" },
                { value: "since", text: "العلوم" },
                { value: "drasa", text: "الدراسات" },
                { value: "eng", text: "اللغة الانجليزية" },
                { value: "fyz", text: "فيزياء" },
                { value: "kims", text: "كيمياء" },
                { value: "ahya", text: "احياء" },
            ];
        
            // حذف جميع الخيارات الموجودة حاليًا
            subjectFilter.innerHTML = '<option value="">-- اختار المادة --</option>';
        
            // إضافة الخيارات المناسبة بناءً على الصف المختار
            allOptions.forEach(option => {
                if ((classFilterValue.includes("خامس") || classFilterValue.includes("سادس") || classFilterValue.includes("سابع") || classFilterValue.includes("ثامن")) && (option.value === "fyz" || option.value === "kims" || option.value === "ahya")) {
                    // لا تضف فيزياء وكيمياء وأحياء
                    return;
                }
                if ((classFilterValue.includes("تاسع") || classFilterValue.includes("عاشر")) && option.value === "since") {
                    // لا تضف العلوم
                    return;
                }
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.text = option.text;
                subjectFilter.appendChild(newOption);
            });
        }
        
        function showTable() {
            const classFilterValue = document.getElementById('classFilter').value;
            const subjectFilterValue = document.getElementById('subjectFilter').value;

            if (classFilterValue && subjectFilterValue) {
                // حفظ حالة التصفية الحالية
                currentFilter.class = classFilterValue;
                currentFilter.subject = subjectFilterValue;
                
                applyFilter(classFilterValue, subjectFilterValue);
            } else {
                alert('برجاء اختيار الصف و المادة معاً.');
            }
        }
        
        function applyFilter(classFilterValue, subjectFilterValue) {
            document.getElementById('studentTable').style.display = 'table';
            document.getElementById('updateAllStudents').style.display = 'inline-block';
            
            const tableBody = document.querySelector("#studentTable tbody");
            const rows = tableBody.querySelectorAll("tr");
            const headers = document.querySelectorAll("#studentTable th");
            
            // إخفاء جميع الأعمدة أولاً
            for (let i = 3; i <= 11; i++) {
                headers[i].style.display = 'none';
            }
            
            // إظهار العمود المحدد فقط
            const columnIndex = getColumnIndex(subjectFilterValue);
            if (columnIndex !== -1) {
                headers[columnIndex].style.display = '';
            }
            
            // تصفية الصفوف وإظهار/إخفاء الأعمدة
            rows.forEach(row => {
                const classNumber = row.cells[1].querySelector('input').value;
                
                if (classNumber.includes(classFilterValue)) {
                    row.style.display = '';
                    
                    // إخفاء جميع أعمدة المواد أولاً
                    for (let i = 3; i <= 11; i++) {
                        row.cells[i].style.display = 'none';
                    }
                    
                    // إظهار العمود المحدد فقط
                    if (columnIndex !== -1) {
                        row.cells[columnIndex].style.display = '';
                    }
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function getColumnIndex(subject) {
            const subjectColumns = {
                "aslm": 3,
                "arb": 4,
                "math": 5,
                "since": 6,
                "drasa": 7,
                "eng": 8,
                "fyz": 9,
                "kims": 10,
                "ahya": 11
            };
            return subjectColumns[subject] || -1;
        }
        
        function updateAllStudents() {
            const tableBody = document.querySelector("#studentTable tbody");
            const rows = tableBody.querySelectorAll("tr");
            const promises = [];

            document.getElementById('loadingMessage').style.display = 'block';

            rows.forEach((row) => {
                // تخطي الصفوف المخفية
                if (row.style.display === 'none') return;
                
                const id = row.cells[0].textContent;
                const formData = new FormData();
                let hasChanges = false;

                // تحضير البيانات وتحديد التغييرات
                ["aslm", "arb", "math", "since", "drasa", "eng", "fyz", "kims", "ahya"].forEach(subject => {
                    const input = document.getElementById(`${subject}_${id}`);
                    if (input) {
                        const originalValue = input.dataset.original;

                        if (input.value !== originalValue) {
                            formData.append(subject, input.value);
                            hasChanges = true;
                        } else {
                            formData.append(subject, originalValue);
                        }
                    }
                });

                // إضافة معلومات الطالب فقط إذا حدث تغيير
                if (hasChanges) {
                    formData.append('id', id);
                    formData.append('cl_num', document.getElementById(`cl_num_${id}`).value);
                    formData.append('student_name', document.getElementById(`student_name_${id}`).value);
                    promises.push(fetch(scriptURL, { method: 'POST', body: formData }));
                }
            });

            // التعامل مع الاستجابة
            if (promises.length === 0) {
                document.getElementById('loadingMessage').style.display = 'none';
                alert('لم يتم إجراء أي تغييرات للحفظ.');
                return;
            }

            Promise.all(promises)
                .then(responses => Promise.all(responses.map(response => response.json())))
                .then(data => {
                    document.getElementById('loadingMessage').style.display = 'none';
                    
                    if (data.every(result => result.status === 'updated')) {
                        alert('تم الحفظ بنجاح ،شكراً!');
                    } else {
                        alert('فشل في تحديث بعض السجلات.');
                    }
                    
                    // إخفاء الجدول وإعادة تعيين التصفية بعد الحفظ
                    resetToInitialState();
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingMessage').style.display = 'none';
                    alert('حدث خطأ أثناء حفظ البيانات.');
                });
        }

        function resetToInitialState() {
            // إخفاء الجدول
            document.getElementById('studentTable').style.display = 'none';
            
            // إخفاء زر الحفظ
            document.getElementById('updateAllStudents').style.display = 'none';
            
            // إعادة تعيين التصفية
            document.getElementById('classFilter').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('subjectFilter').innerHTML = '<option value="">-- اختار المادة --</option>';
            
            // إعادة تعيين حالة التصفية الحالية
            currentFilter.class = '';
            currentFilter.subject = '';
        }

        window.onload = loadData;
    </script>
</body>
</html>
